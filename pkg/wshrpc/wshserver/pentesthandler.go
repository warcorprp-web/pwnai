// Copyright 2025, Command Line Inc.
// SPDX-License-Identifier: Apache-2.0

package wshserver

import (
	"context"
	"fmt"
	"log"

	"github.com/wavetermdev/waveterm/pkg/pentest"
	"github.com/wavetermdev/waveterm/pkg/wshrpc"
)

var pentestService *pentest.PentestService

// InitPentestService –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–µ—Ä–≤–∏—Å –ø–µ–Ω—Ç–µ—Å—Ç–∏–Ω–≥–∞
func InitPentestService() error {
	var err error
	pentestService, err = pentest.NewPentestService("127.0.0.1", 55553, "879621")
	if err != nil {
		return fmt.Errorf("–æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ pentest —Å–µ—Ä–≤–∏—Å–∞: %w", err)
	}
	log.Printf("‚úÖ PwnAI Pentest Service –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
	return nil
}

// ScanTargetCommand - RPC –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
func ScanTargetCommand(ctx context.Context, data map[string]interface{}) (interface{}, error) {
	target, _ := data["target"].(string)
	if target == "" {
		return nil, fmt.Errorf("–Ω–µ —É–∫–∞–∑–∞–Ω–∞ —Ü–µ–ª—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è")
	}

	scanType, _ := data["scanType"].(string)
	if scanType == "" {
		scanType = "quick"
	}

	log.Printf("üîç RPC: –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ %s (—Ç–∏–ø: %s)", target, scanType)
	return pentestService.ScanTarget(target, scanType)
}

// ExploitTargetCommand - RPC –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏
func ExploitTargetCommand(ctx context.Context, data map[string]interface{}) (interface{}, error) {
	target, _ := data["target"].(string)
	if target == "" {
		return nil, fmt.Errorf("–Ω–µ —É–∫–∞–∑–∞–Ω–∞ —Ü–µ–ª—å")
	}

	exploit, _ := data["exploit"].(string)
	if exploit == "" {
		return nil, fmt.Errorf("–Ω–µ —É–∫–∞–∑–∞–Ω —ç–∫—Å–ø–ª–æ–π—Ç")
	}

	port := 445
	if p, ok := data["port"].(float64); ok {
		port = int(p)
	}
	
	lhost, _ := data["lhost"].(string)
	if lhost == "" {
		lhost = "192.168.1.50"
	}

	log.Printf("üéØ RPC: –≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è %s —Å %s", target, exploit)
	return pentestService.ExploitTarget(target, exploit, port, lhost)
}

// ListSessionsCommand - RPC –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞ —Å–µ—Å—Å–∏–π
func ListSessionsCommand(ctx context.Context, data map[string]interface{}) (interface{}, error) {
	log.Printf("üìä RPC: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–µ—Å—Å–∏–π")
	return pentestService.ListSessions()
}

// RunSessionCommandCommand - RPC –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ —Å–µ—Å—Å–∏–∏
func RunSessionCommandCommand(ctx context.Context, data map[string]interface{}) (interface{}, error) {
	sessionID := 0
	if sid, ok := data["sessionId"].(float64); ok {
		sessionID = int(sid)
	}
	if sessionID == 0 {
		return nil, fmt.Errorf("–Ω–µ —É–∫–∞–∑–∞–Ω ID —Å–µ—Å—Å–∏–∏")
	}

	command, _ := data["command"].(string)
	if command == "" {
		return nil, fmt.Errorf("–Ω–µ —É–∫–∞–∑–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞")
	}

	log.Printf("‚ö° RPC: –ö–æ–º–∞–Ω–¥–∞ '%s' –≤ —Å–µ—Å—Å–∏–∏ %d", command, sessionID)
	return pentestService.RunSessionCommand(sessionID, command)
}

// MsfRpcCallCommand - RPC –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä—è–º–æ–≥–æ –≤—ã–∑–æ–≤–∞ MSF RPC
func MsfRpcCallCommand(ctx context.Context, data map[string]interface{}) (interface{}, error) {
	method, _ := data["method"].(string)
	if method == "" {
		return nil, fmt.Errorf("–Ω–µ —É–∫–∞–∑–∞–Ω –º–µ—Ç–æ–¥")
	}

	params, _ := data["params"].([]interface{})
	if params == nil {
		params = []interface{}{}
	}

	log.Printf("üîß RPC: MSF –≤—ã–∑–æ–≤ %s", method)
	return pentestService.MSF.Call(method, params)
}


// PentestToolResultCommand - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
func PentestToolResultCommand(ctx context.Context, data wshrpc.CommandData) (interface{}, error) {
	toolCallID := data.GetString("toolCallId", "")
	if toolCallID == "" {
		return nil, fmt.Errorf("–Ω–µ —É–∫–∞–∑–∞–Ω ID –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞")
	}

	toolName := data.GetString("toolName", "")
	if toolName == "" {
		return nil, fmt.Errorf("–Ω–µ —É–∫–∞–∑–∞–Ω–æ –∏–º—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞")
	}

	// –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
	params := data.GetMap("params")
	if params == nil {
		params = make(map[string]interface{})
	}

	log.Printf("üîß –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞: %s (ID: %s)", toolName, toolCallID)

	var result interface{}
	var err error

	// –í—ã–ø–æ–ª–Ω—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
	switch toolName {
	case "scan_target":
		target, _ := params["target"].(string)
		scanType, _ := params["scan_type"].(string)
		if scanType == "" {
			scanType = "quick"
		}
		result, err = pentestService.ScanTarget(target, scanType)

	case "search_exploits":
		query, _ := params["query"].(string)
		result, err = pentestService.SearchExploits(query)

	case "exploit_target":
		target, _ := params["target"].(string)
		exploit, _ := params["exploit_module"].(string)
		port := int(params["port"].(float64))
		if port == 0 {
			port = 445
		}
		lhost, _ := params["lhost"].(string)
		if lhost == "" {
			lhost = "192.168.1.50"
		}
		result, err = pentestService.ExploitTarget(target, exploit, port, lhost)

	case "list_sessions":
		result, err = pentestService.ListSessions()

	case "run_session_command":
		sessionID := int(params["session_id"].(float64))
		command, _ := params["command"].(string)
		result, err = pentestService.RunSessionCommand(sessionID, command)

	case "msf_rpc_call":
		method, _ := params["method"].(string)
		rpcParams, _ := params["params"].([]interface{})
		if rpcParams == nil {
			rpcParams = []interface{}{}
		}
		result, err = pentestService.MSF.Call(method, rpcParams)

	case "read_file":
		path, _ := params["path"].(string)
		content, fileErr := pentestService.ReadFile(path)
		if fileErr != nil {
			err = fileErr
		} else {
			result = map[string]interface{}{"content": content, "path": path}
		}

	case "write_file":
		path, _ := params["path"].(string)
		content, _ := params["content"].(string)
		err = pentestService.WriteFile(path, content)
		if err == nil {
			result = map[string]interface{}{"success": true, "path": path}
		}

	case "edit_file":
		path, _ := params["path"].(string)
		oldText, _ := params["old_text"].(string)
		newText, _ := params["new_text"].(string)
		err = pentestService.EditFile(path, oldText, newText)
		if err == nil {
			result = map[string]interface{}{"success": true, "path": path}
		}

	case "execute_command":
		command, _ := params["command"].(string)
		output, cmdErr := pentestService.ExecuteCommand(command)
		result = map[string]interface{}{"output": output}
		if cmdErr != nil {
			err = cmdErr
		}

	case "open_browser":
		url, _ := params["url"].(string)
		tabId, _ := params["tab_id"].(string)
		widgetId, browserErr := pentestService.OpenBrowser(context.Background(), tabId, url)
		if browserErr != nil {
			err = browserErr
		} else {
			result = map[string]interface{}{"success": true, "widget_id": widgetId, "url": url}
		}

	case "create_terminal":
		command, _ := params["command"].(string)
		tabId, _ := params["tab_id"].(string)
		widgetId, termErr := pentestService.CreateTerminal(context.Background(), tabId, command)
		if termErr != nil {
			err = termErr
		} else {
			result = map[string]interface{}{"success": true, "widget_id": widgetId}
		}

	case "open_preview":
		path, _ := params["path"].(string)
		tabId, _ := params["tab_id"].(string)
		widgetId, previewErr := pentestService.OpenPreview(context.Background(), tabId, path)
		if previewErr != nil {
			err = previewErr
		} else {
			result = map[string]interface{}{"success": true, "widget_id": widgetId, "path": path}
		}

	case "capture_screenshot":
		// TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ Wave screenshot API
		result = map[string]interface{}{"success": false, "message": "screenshot –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω"}

	default:
		return nil, fmt.Errorf("–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: %s", toolName)
	}

	if err != nil {
		log.Printf("‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è %s: %v", toolName, err)
		return map[string]interface{}{
			"error":   true,
			"message": err.Error(),
		}, nil
	}

	log.Printf("‚úÖ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç %s –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ", toolName)
	return result, nil
}
